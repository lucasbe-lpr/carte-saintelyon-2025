<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Parcours SaintéLyon 2025 - Le Progrès</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet"/>

  <style>
    /* ==================================================================
       NAMESPACE #lyon-widget
    ================================================================== */
    #lyon-widget {
      --lw-bg: #FFFFFF; --lw-bg-alt: #F8F9FA; --lw-text: #212529; --lw-muted: #6C757D;
      --lw-accent: #212529; --lw-orange: #E65100; --lw-border: #DEE2E6; --lw-radius: 0px;
      --lw-font-main: 'Roboto', sans-serif;
    }
    #lyon-widget.lw-dark {
        --lw-bg: #1A1A1A; --lw-bg-alt: #252525; --lw-text: #E9ECEF; --lw-muted: #ADB5BD;
        --lw-accent: #FFFFFF; --lw-border: #343A40;
    }
    
    /* RESET TOTAL POUR EVITER LE SCROLL */
    html, body { height: 100%; width: 100%; margin: 0; padding: 0; overflow: hidden; background-color: transparent; }
    
    /* STRUCTURE "APP" */
    #lyon-widget {
        font-family: var(--lw-font-main); color: var(--lw-text); background-color: var(--lw-bg);
        width: 100%; height: 100%; /* Prend tout l'espace de l'iframe */
        display: flex; flex-direction: column; /* Empilement vertical */
        overflow: hidden; /* Coupe tout ce qui dépasse */
    }

    /* HEADER - Taille fixe */
    #lyon-widget header { padding: 12px 15px; border-bottom: 1px solid var(--lw-border); background-color: var(--lw-bg); flex-shrink: 0; }
    #lyon-widget h1 { font-size: 20px; font-weight: 700; color: var(--lw-accent); margin: 0; text-transform: uppercase; line-height: 1.2; }
    #lyon-widget .lw-subtitle { font-size: 12px; color: var(--lw-orange); font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 2px;}

    /* CONTROLS - Taille adaptative */
    #lyon-widget .lw-controls { padding: 10px; background-color: var(--lw-bg-alt); border-bottom: 1px solid var(--lw-border); flex-shrink: 0; }
    #lyon-widget .lw-course-selector { display: flex; flex-wrap: wrap; gap: 6px; justify-content: center; }
    #lyon-widget .lw-btn {
        padding: 6px 12px; font-size: 12px; font-weight: 500; cursor: pointer; border-radius: 16px; 
        border: 1px solid var(--lw-border); background-color: var(--lw-bg); color: var(--lw-muted);
        transition: all 0.2s; display: flex; align-items: center; gap: 5px; user-select: none; white-space: nowrap;
    }
    #lyon-widget .lw-btn:hover { border-color: var(--lw-orange); color: var(--lw-orange); }
    #lyon-widget .lw-btn.active { background-color: var(--lw-orange); color: #FFF; border-color: var(--lw-orange); font-weight: 700; }
    #lyon-widget .lw-btn-dot { width: 6px; height: 6px; border-radius: 50%; background-color: var(--lw-muted); }
    #lyon-widget .lw-btn.active .lw-btn-dot { background-color: #FFF; }
    
    /* MAP - C'EST ICI QUE LA MAGIE OPERE (Flex 1 = prend tout l'espace restant) */
    #lyon-widget #lw-map-wrapper { 
        position: relative; width: 100%; 
        flex: 1; /* Elastique ! */
        min-height: 150px; /* Sécurité pour ne pas disparaître */
        z-index: 1; 
    }
    #lyon-widget #lw-map { width: 100%; height: 100%; background: var(--lw-bg-alt); }
    
    /* CHART - Taille fixe en bas */
    #lyon-widget .lw-chart-container { 
        padding: 10px 15px 0 15px; 
        height: 200px; /* Hauteur contrainte */
        background: var(--lw-bg); 
        border-top: 1px solid var(--lw-border);
        flex-shrink: 0; 
        display: flex; flex-direction: column;
    }
    #lyon-widget .lw-stats { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 5px; font-size: 12px; color: var(--lw-text); justify-content: center; }
    #lyon-widget .lw-stat-val { font-weight: 700; color: var(--lw-orange); font-family: monospace; font-size: 13px; }
    #lyon-widget canvas { flex: 1; min-height: 0; max-height: 160px; } 

    /* FOOTER - Taille fixe tout en bas */
    #lyon-widget footer { 
        padding: 8px 15px; background: var(--lw-bg-alt); border-top: 1px solid var(--lw-border); 
        display: flex; justify-content: space-between; align-items: center; font-size: 10px; color: var(--lw-muted);
        flex-shrink: 0; 
    }
    
    #lyon-widget .lw-toggle-wrapper { display: flex; align-items: center; gap: 6px; cursor: pointer; }
    #lyon-widget .lw-switch { position: relative; width: 28px; height: 16px; background: var(--lw-border); border-radius: 20px; transition: 0.2s; }
    #lyon-widget .lw-switch::after { content: ""; position: absolute; top: 2px; left: 2px; width: 12px; height: 12px; border-radius: 50%; background: #FFF; transition: 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
    #lyon-widget input:checked + .lw-switch { background: var(--lw-orange); }
    #lyon-widget input:checked + .lw-switch::after { transform: translateX(12px); }

    /* MOBILE TWEAKS */
    @media (max-height: 600px) {
        /* Si l'écran est très petit en hauteur, on réduit le chart */
        #lyon-widget .lw-chart-container { height: 160px; }
        #lyon-widget header { padding: 8px 15px; }
    }
    
    /* ERROR MSG */
    #lyon-widget .lw-error-msg {
        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        background: rgba(255, 255, 255, 0.95); border: 2px solid #E65100; padding: 15px; border-radius: 8px;
        font-size: 13px; color: #D32F2F; font-weight: bold; z-index: 2000; text-align: center; width: 80%;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2); display: none;
    }
    #lyon-widget .lw-error-msg.active { display: block; }

  </style>
</head>
<body>

<div id="lyon-widget">
  <header>
    <div class="lw-subtitle">SaintéLyon 2025</div>
    <h1>Carte des parcours</h1>
  </header>

  <div class="lw-controls">
    <div class="lw-course-selector" id="course-buttons"></div>
  </div>

  <div id="lw-map-wrapper">
    <div id="lw-map"></div>
    <div class="lw-error-msg" id="lw-error"></div>
  </div>

  <div class="lw-chart-container">
    <div class="lw-stats">
        <span>Dist. <span class="lw-stat-val" id="stat-dist">-</span></span>
        <span>D+ <span class="lw-stat-val" id="stat-dplus">-</span></span>
        <span>Alt. Max <span class="lw-stat-val" id="stat-alt">-</span></span>
    </div>
    <canvas id="elevationChart"></canvas>
  </div>

  <footer> 
    <div class="lw-source-credit">Données : <b>OpenRunner</b></div>
    <label class="lw-toggle-wrapper">
        <input type="checkbox" id="lw-dark-check" style="display:none">
        <span class="lw-switch"></span>
        <span>Sombre</span>
    </label>
  </footer>
</div>

<script>
(function() {
    
    const COURSES = {
        "lyonsaintelyon": { name: "LyonSaintéLyon", url: "data/lyonsaintelyon.gpx", color: "#111111", cache: null },
        "saintelyon":     { name: "La SaintéLyon",  url: "data/saintelyon.gpx",     color: "#E65100", cache: null },
        "saintexpress":   { name: "SaintExpress",   url: "data/saintexpress.gpx",   color: "#D32F2F", cache: null },
        "saintesprint":   { name: "SaintéSprint",   url: "data/saintesprint.gpx",   color: "#1976D2", cache: null },
        "saintetic":      { name: "SaintéTic",      url: "data/saintetic.gpx",      color: "#388E3C", cache: null }
    };

    const state = { map: null, currentLayer: null, chart: null, activeCourseKey: 'saintelyon' };

    async function fetchGPX(key) {
        const course = COURSES[key];
        const errorBox = document.getElementById('lw-error');
        errorBox.classList.remove('active'); 

        if (course.cache) return course.cache;

        try {
            const response = await fetch(course.url);
            if (!response.ok) throw new Error(`Fichier "${course.url}" introuvable.`);
            const str = await response.text();
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(str, "text/xml");
            if (xmlDoc.querySelector("parsererror")) throw new Error("GPX mal formé.");
            const trkpts = xmlDoc.getElementsByTagName("trkpt");
            if (trkpts.length === 0) throw new Error("Aucun point GPS trouvé.");
            
            let points = [];
            // On prend tous les points mais on simplifie si > 4000 pour la perf mobile
            const step = trkpts.length > 4000 ? 2 : 1;
            for (let i = 0; i < trkpts.length; i += step) {
                const lat = parseFloat(trkpts[i].getAttribute("lat"));
                const lon = parseFloat(trkpts[i].getAttribute("lon"));
                const ele = parseFloat(trkpts[i].getElementsByTagName("ele")[0]?.textContent || 0);
                points.push([lat, lon, ele]);
            }
            course.cache = points;
            return points;
        } catch (e) {
            console.error(e);
            errorBox.innerHTML = `⚠️ ${e.message}`;
            errorBox.classList.add('active');
            return [];
        }
    }

    function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371; 
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    function processDataForChart(points) {
        let distLabels = [];
        let elevations = [];
        let totalDist = 0;
        let dPlus = 0;
        let maxAlt = 0;

        for (let i = 0; i < points.length; i++) {
            if (i > 0) {
                const d = calculateDistance(points[i-1][0], points[i-1][1], points[i][0], points[i][1]);
                totalDist += d;
                if (points[i][2] > points[i-1][2]) dPlus += (points[i][2] - points[i-1][2]);
            }
            if (points[i][2] > maxAlt) maxAlt = points[i][2];
            
            // On échantillonne pour le graphique uniquement (100 points max)
            // Cela rend le tooltip fluide et évite l'effet "écrasé" d'avoir 5000 points
            const chartStep = Math.max(1, Math.floor(points.length / 150));
            if (i % chartStep === 0 || i === points.length - 1) { 
                 distLabels.push(totalDist.toFixed(1));
                 elevations.push(points[i][2]);
            }
        }
        return { labels: distLabels, data: elevations, stats: { dist: totalDist.toFixed(1), dPlus: Math.round(dPlus), maxAlt: Math.round(maxAlt) } };
    }

    let marker = null;

    function updateMapMarker(index, points, ratio) {
        // On retrouve l'index réel grâce au ratio
        const realIndex = Math.floor(index * ratio);
        const pt = points[Math.min(realIndex, points.length - 1)];
        if (!pt) return;

        if (marker) {
            marker.setLatLng([pt[0], pt[1]]);
            marker.addTo(state.map);
        } else {
            marker = L.circleMarker([pt[0], pt[1]], { radius: 6, fillColor: COURSES[state.activeCourseKey].color, color: "#FFF", weight: 2, opacity: 1, fillOpacity: 1 }).addTo(state.map);
        }
    }

    async function switchCourse(key) {
        state.activeCourseKey = key;
        const course = COURSES[key];

        document.querySelectorAll('.lw-btn').forEach(b => {
            b.classList.remove('active');
            b.querySelector('.lw-btn-dot').style.backgroundColor = ''; 
            if (b.textContent.includes(course.name)) {
                b.classList.add('active');
                b.querySelector('.lw-btn-dot').style.backgroundColor = '#FFF';
            } else {
                const k = Object.keys(COURSES).find(ck => b.textContent.includes(COURSES[ck].name));
                if(k) b.querySelector('.lw-btn-dot').style.backgroundColor = COURSES[k].color;
            }
        });

        const points = await fetchGPX(key);
        if(points.length === 0) return;

        const processed = processDataForChart(points);
        const ratio = points.length / processed.data.length;

        document.getElementById('stat-dist').innerText = processed.stats.dist + " km";
        document.getElementById('stat-dplus').innerText = processed.stats.dPlus + " m";
        document.getElementById('stat-alt').innerText = processed.stats.maxAlt + " m";

        if (state.currentLayer) state.map.removeLayer(state.currentLayer);
        const latlngs = points.map(p => [p[0], p[1]]);
        state.currentLayer = L.polyline(latlngs, { color: course.color, weight: 4, opacity: 0.8, lineJoin: 'round' }).addTo(state.map);
        state.map.fitBounds(state.currentLayer.getBounds(), { padding: [20, 20] });

        state.chart.data.labels = processed.labels;
        state.chart.data.datasets[0].data = processed.data;
        state.chart.data.datasets[0].borderColor = course.color;
        state.chart.data.datasets[0].backgroundColor = hexToRgba(course.color, 0.2);
        
        state.chart.options.onHover = (e, elements) => {
            if (elements && elements.length > 0) updateMapMarker(elements[0].index, points, ratio);
            else if(marker) marker.remove();
        };
        state.chart.update();
    }

    function hexToRgba(hex, alpha) {
        const r = parseInt(hex.slice(1, 3), 16);
        const g = parseInt(hex.slice(3, 5), 16);
        const b = parseInt(hex.slice(5, 7), 16);
        return `rgba(${r}, ${g}, ${b}, ${alpha})`;
    }

    function init() {
        state.map = L.map('lw-map', { zoomControl: false }).setView([45.6, 4.6], 10);
        L.control.zoom({ position: 'topright' }).addTo(state.map);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OSM &copy; CARTO', subdomains: 'abcd', maxZoom: 19
        }).addTo(state.map);

        const btnContainer = document.getElementById('course-buttons');
        Object.keys(COURSES).forEach(key => {
            const c = COURSES[key];
            const btn = document.createElement('div');
            btn.className = `lw-btn ${key === state.activeCourseKey ? 'active' : ''}`;
            btn.innerHTML = `<div class="lw-btn-dot" style="background-color:${key === state.activeCourseKey ? '#FFF' : c.color}"></div> ${c.name}`;
            btn.onclick = () => switchCourse(key);
            btnContainer.appendChild(btn);
        });

        const ctx = document.getElementById('elevationChart').getContext('2d');
        state.chart = new Chart(ctx, {
            type: 'line',
            data: { labels: [], datasets: [{ label: 'Altitude (m)', data: [], borderWidth: 1.5, pointRadius: 0, pointHoverRadius: 6, fill: true, tension: 0.2 }] },
            options: {
                responsive: true, 
                maintainAspectRatio: false,
                plugins: { 
                    legend: { display: false }, 
                    tooltip: { 
                        mode: 'index', 
                        intersect: false,
                        backgroundColor: 'rgba(255, 255, 255, 0.95)',
                        titleColor: '#000',
                        bodyColor: '#333',
                        borderColor: '#ccc',
                        borderWidth: 1,
                        padding: 10,
                        titleFont: { size: 14, family: "'Roboto', sans-serif" },
                        bodyFont: { size: 13, family: "'Roboto', sans-serif" },
                        callbacks: { title: (i) => `Km ${i[0].label}`, label: (i) => `${Math.round(i.raw)} m` } 
                    } 
                },
                scales: { 
                    x: { grid: { display: false }, ticks: { maxTicksLimit: 6, font: {size: 10} } }, 
                    y: { grid: { color: 'rgba(0,0,0,0.05)' }, ticks: { font: {size: 10} } } 
                },
                interaction: { mode: 'nearest', axis: 'x', intersect: false }
            }
        });

        document.getElementById('lw-dark-check').onchange = (e) => {
            document.getElementById('lyon-widget').classList.toggle('lw-dark', e.target.checked);
            const textColor = e.target.checked ? '#ADB5BD' : '#666';
            state.chart.options.scales.x.ticks.color = textColor;
            state.chart.options.scales.y.ticks.color = textColor;
            state.chart.update();
        };

        switchCourse('saintelyon');
    }

    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
    else init();

})();
</script>
</body>
</html>
