<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Parcours SaintéLyon 2025 - Le Progrès</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet"/>

  <style>
    /* ==================================================================
       NAMESPACE #lyon-widget
    ================================================================== */
    #lyon-widget {
      --lw-bg: #FFFFFF; --lw-bg-alt: #F8F9FA; --lw-text: #212529; --lw-muted: #6C757D;
      --lw-accent: #212529; --lw-orange: #E65100; --lw-border: #DEE2E6; --lw-radius: 8px;
      --lw-font-main: 'Roboto', sans-serif; --lw-shadow: 0 2px 12px rgba(0,0,0,0.08);
    }
    #lyon-widget.lw-dark {
        --lw-bg: #1A1A1A; --lw-bg-alt: #252525; --lw-text: #E9ECEF; --lw-muted: #ADB5BD;
        --lw-accent: #FFFFFF; --lw-border: #343A40; --lw-shadow: 0 4px 20px rgba(0,0,0,0.4);
    }
    #lyon-widget * { box-sizing: border-box; margin: 0; padding: 0; }
    #lyon-widget {
        font-family: var(--lw-font-main); color: var(--lw-text); background-color: var(--lw-bg);
        width: 100%; max-width: 900px; margin: 0 auto; border-radius: var(--lw-radius);
        border: 1px solid var(--lw-border); display: flex; flex-direction: column;
        overflow: hidden; box-shadow: var(--lw-shadow);
    }
    /* HEADER */
    #lyon-widget header { padding: 20px; border-bottom: 1px solid var(--lw-border); background-color: var(--lw-bg); }
    #lyon-widget h1 { font-size: 24px; font-weight: 700; color: var(--lw-accent); margin-bottom: 6px; text-transform: uppercase; }
    #lyon-widget .lw-subtitle { font-size: 14px; color: var(--lw-orange); font-weight: 700; text-transform: uppercase; letter-spacing: 1px;}
    #lyon-widget .lw-desc { font-size: 14px; color: var(--lw-muted); margin-top: 5px; }
    /* CONTROLS */
    #lyon-widget .lw-controls { padding: 15px 20px; background-color: var(--lw-bg-alt); border-bottom: 1px solid var(--lw-border); }
    #lyon-widget .lw-course-selector { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
    #lyon-widget .lw-btn {
        padding: 8px 16px; font-size: 13px; font-weight: 500; cursor: pointer; border-radius: 20px; 
        border: 1px solid var(--lw-border); background-color: var(--lw-bg); color: var(--lw-muted);
        transition: all 0.2s; display: flex; align-items: center; gap: 6px; user-select: none;
    }
    #lyon-widget .lw-btn:hover { border-color: var(--lw-orange); color: var(--lw-orange); }
    #lyon-widget .lw-btn.active { background-color: var(--lw-orange); color: #FFF; border-color: var(--lw-orange); font-weight: 700; }
    #lyon-widget .lw-btn-dot { width: 8px; height: 8px; border-radius: 50%; background-color: var(--lw-muted); }
    #lyon-widget .lw-btn.active .lw-btn-dot { background-color: #FFF; }
    /* MAP & LOADERS */
    #lyon-widget #lw-map-wrapper { position: relative; width: 100%; height: 450px; z-index: 1; }
    #lyon-widget #lw-map { width: 100%; height: 100%; background: var(--lw-bg-alt); }
    #lyon-widget .lw-loader {
        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        background: rgba(255,255,255,0.9); padding: 10px 20px; border-radius: 20px;
        font-size: 12px; color: var(--lw-orange); font-weight: bold; z-index: 1000;
        display: none; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    #lyon-widget .lw-loader.active { display: block; }
    /* CHART */
    #lyon-widget .lw-chart-container { padding: 15px 20px; height: 220px; background: var(--lw-bg); border-top: 1px solid var(--lw-border); }
    #lyon-widget .lw-stats { display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 10px; font-size: 14px; color: var(--lw-text); }
    #lyon-widget .lw-stat-val { font-weight: 700; color: var(--lw-orange); }
    /* FOOTER */
    #lyon-widget footer { padding: 12px 20px; background: var(--lw-bg-alt); border-top: 1px solid var(--lw-border); display: flex; justify-content: space-between; align-items: center; font-size: 11px; color: var(--lw-muted); }
    #lyon-widget .lw-toggle-wrapper { display: flex; align-items: center; gap: 8px; cursor: pointer; }
    #lyon-widget .lw-switch { position: relative; width: 32px; height: 18px; background: var(--lw-border); border-radius: 20px; transition: 0.2s; }
    #lyon-widget .lw-switch::after { content: ""; position: absolute; top: 2px; left: 2px; width: 14px; height: 14px; border-radius: 50%; background: #FFF; transition: 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
    #lyon-widget input:checked + .lw-switch { background: var(--lw-orange); }
    #lyon-widget input:checked + .lw-switch::after { transform: translateX(14px); }
  </style>
</head>
<body>

<div id="lyon-widget">
  <header>
    <div class="lw-subtitle">SaintéLyon 2025</div>
    <h1>La carte interactive des parcours</h1>
    <div class="lw-desc">Découvrez le tracé officiel et le profil altimétrique de chaque épreuve.</div>
  </header>

  <div class="lw-controls">
    <div class="lw-course-selector" id="course-buttons"></div>
  </div>

  <div id="lw-map-wrapper">
    <div id="lw-map"></div>
    <div class="lw-loader" id="lw-loader">Chargement du tracé...</div>
  </div>

  <div class="lw-chart-container">
    <div class="lw-stats">
        <span>Distance : <span class="lw-stat-val" id="stat-dist">-</span></span>
        <span>Dénivelé + : <span class="lw-stat-val" id="stat-dplus">-</span></span>
        <span>Altitude max : <span class="lw-stat-val" id="stat-alt">-</span></span>
    </div>
    <canvas id="elevationChart"></canvas>
  </div>

  <footer> 
    <div class="lw-source-credit">Données : <b>OpenRunner / SaintéLyon</b></div>
    <label class="lw-toggle-wrapper">
        <input type="checkbox" id="lw-dark-check" style="display:none">
        <span class="lw-switch"></span>
        <span>Mode sombre</span>
    </label>
  </footer>
</div>

<script>
(function() {
    // =============================================================
    // CONFIGURATION : Chemins vers vos fichiers GPX
    // =============================================================
    
    const COURSES = {
        "lyonsaintelyon": {
            name: "LyonSaintéLyon",
            url: "data/lyonsaintelyon.gpx", // Chemin relatif
            color: "#111111",
            cache: null // Pour stocker les données une fois chargées
        },
        "saintelyon": {
            name: "La SaintéLyon",
            url: "data/saintelyon.gpx",
            color: "#E65100",
            cache: null
        },
        "saintexpress": {
            name: "SaintExpress",
            url: "data/saintexpress.gpx",
            color: "#D32F2F",
            cache: null
        },
        "saintesprint": {
            name: "SaintéSprint",
            url: "data/saintesprint.gpx",
            color: "#1976D2",
            cache: null
        },
        "saintetic": {
            name: "SaintéTic",
            url: "data/saintetic.gpx",
            color: "#388E3C",
            cache: null
        }
    };

    const state = { map: null, currentLayer: null, chart: null, activeCourseKey: 'saintelyon' };

    // --- CHARGEMENT ET PARSING GPX ---
    async function fetchGPX(key) {
        const course = COURSES[key];
        
        // Si déjà chargé en mémoire, on le retourne direct
        if (course.cache) return course.cache;

        // Afficher loader
        document.getElementById('lw-loader').classList.add('active');

        try {
            const response = await fetch(course.url);
            if (!response.ok) throw new Error("Fichier non trouvé");
            const str = await response.text();
            
            // Parsing XML manuel (plus léger qu'une librairie externe)
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(str, "text/xml");
            const trkpts = xmlDoc.getElementsByTagName("trkpt");
            
            let points = [];
            // On ne prend qu'un point sur 2 pour alléger le navigateur si le fichier est énorme
            // (tu peux changer le pas : i+=1 pour tout prendre, i+=5 pour alléger)
            const step = trkpts.length > 5000 ? 5 : 1; 

            for (let i = 0; i < trkpts.length; i += step) {
                const lat = parseFloat(trkpts[i].getAttribute("lat"));
                const lon = parseFloat(trkpts[i].getAttribute("lon"));
                const eleTag = trkpts[i].getElementsByTagName("ele")[0];
                const ele = eleTag ? parseFloat(eleTag.textContent) : 0;
                points.push([lat, lon, ele]);
            }
            
            course.cache = points; // Sauvegarde en mémoire
            return points;
        } catch (e) {
            console.error("Erreur chargement GPX:", e);
            alert("Impossible de charger le tracé. Vérifiez que le fichier .gpx est bien dans le dossier data/");
            return [];
        } finally {
            document.getElementById('lw-loader').classList.remove('active');
        }
    }

    // --- CALCULS GÉOGRAPHIQUES ---
    function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371; 
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                  Math.sin(dLon/2) * Math.sin(dLon/2);
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    function processDataForChart(points) {
        let distLabels = [];
        let elevations = [];
        let totalDist = 0;
        let dPlus = 0;
        let maxAlt = 0;

        for (let i = 0; i < points.length; i++) {
            if (i > 0) {
                const d = calculateDistance(points[i-1][0], points[i-1][1], points[i][0], points[i][1]);
                totalDist += d;
                const diff = points[i][2] - points[i-1][2];
                if (diff > 0) dPlus += diff;
            }
            if (points[i][2] > maxAlt) maxAlt = points[i][2];
            // On limite le nombre de labels pour ne pas surcharger le graph
            if (i % 20 === 0 || i === points.length -1) { 
                 distLabels.push(totalDist.toFixed(1));
                 elevations.push(points[i][2]);
            } else {
                 distLabels.push(""); // Point caché sur l'axe X
                 elevations.push(points[i][2]);
            }
        }

        return {
            labels: distLabels,
            data: elevations,
            stats: {
                dist: totalDist.toFixed(1),
                dPlus: Math.round(dPlus),
                maxAlt: Math.round(maxAlt)
            }
        };
    }

    let marker = null;
    let currentPoints = [];

    function updateMapMarker(index, points) {
        if (!points[index]) return;
        const pt = points[index];
        if (marker) {
            marker.setLatLng([pt[0], pt[1]]);
            marker.addTo(state.map);
        } else {
            marker = L.circleMarker([pt[0], pt[1]], {
                radius: 6, fillColor: COURSES[state.activeCourseKey].color, color: "#FFF", weight: 2, opacity: 1, fillOpacity: 1
            }).addTo(state.map);
        }
    }

    async function switchCourse(key) {
        state.activeCourseKey = key;
        const course = COURSES[key];

        // Update UI Boutons
        document.querySelectorAll('.lw-btn').forEach(b => {
            b.classList.remove('active');
            b.querySelector('.lw-btn-dot').style.backgroundColor = ''; 
            if (b.textContent.includes(course.name)) {
                b.classList.add('active');
                b.querySelector('.lw-btn-dot').style.backgroundColor = '#FFF';
            } else {
                const k = Object.keys(COURSES).find(ck => b.textContent.includes(COURSES[ck].name));
                if(k) b.querySelector('.lw-btn-dot').style.backgroundColor = COURSES[k].color;
            }
        });

        // Chargement Async du GPX
        const points = await fetchGPX(key);
        if(points.length === 0) return;
        currentPoints = points;

        // Calcul Stats
        const processed = processDataForChart(points);

        // Affichage Stats
        document.getElementById('stat-dist').innerText = processed.stats.dist + " km";
        document.getElementById('stat-dplus').innerText = processed.stats.dPlus + " m";
        document.getElementById('stat-alt').innerText = processed.stats.maxAlt + " m";

        // Carte
        if (state.currentLayer) state.map.removeLayer(state.currentLayer);
        const latlngs = points.map(p => [p[0], p[1]]);
        
        state.currentLayer = L.polyline(latlngs, {
            color: course.color, weight: 4, opacity: 0.8, lineJoin: 'round'
        }).addTo(state.map);
        
        state.map.fitBounds(state.currentLayer.getBounds(), { padding: [20, 20] });

        // Graphique
        state.chart.data.labels = processed.labels;
        state.chart.data.datasets[0].data = processed.data;
        state.chart.data.datasets[0].borderColor = course.color;
        state.chart.data.datasets[0].backgroundColor = hexToRgba(course.color, 0.2);
        state.chart.options.onHover = (e, elements) => {
            if (elements && elements.length > 0) updateMapMarker(elements[0].index, points);
            else if(marker) marker.remove();
        };
        state.chart.update();
    }

    function hexToRgba(hex, alpha) {
        const r = parseInt(hex.slice(1, 3), 16);
        const g = parseInt(hex.slice(3, 5), 16);
        const b = parseInt(hex.slice(5, 7), 16);
        return `rgba(${r}, ${g}, ${b}, ${alpha})`;
    }

    function init() {
        state.map = L.map('lw-map', { zoomControl: false }).setView([45.6, 4.6], 10);
        L.control.zoom({ position: 'topright' }).addTo(state.map);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OSM &copy; CARTO', subdomains: 'abcd', maxZoom: 19
        }).addTo(state.map);

        const btnContainer = document.getElementById('course-buttons');
        Object.keys(COURSES).forEach(key => {
            const c = COURSES[key];
            const btn = document.createElement('div');
            btn.className = `lw-btn ${key === state.activeCourseKey ? 'active' : ''}`;
            btn.innerHTML = `<div class="lw-btn-dot" style="background-color:${key === state.activeCourseKey ? '#FFF' : c.color}"></div> ${c.name}`;
            btn.onclick = () => switchCourse(key);
            btnContainer.appendChild(btn);
        });

        const ctx = document.getElementById('elevationChart').getContext('2d');
        state.chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Altitude (m)', data: [], borderColor: '#E65100', backgroundColor: 'rgba(230, 81, 0, 0.1)',
                    borderWidth: 1, pointRadius: 0, pointHoverRadius: 6, fill: true, tension: 0.1
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false, displayColors: false, callbacks: { title: (i) => `Km ${i[0].label}`, label: (i) => `${Math.round(i.raw)} m` } } },
                scales: { x: { grid: { display: false }, ticks: { maxTicksLimit: 8, font: {size: 10} } }, y: { grid: { color: 'rgba(0,0,0,0.05)' }, ticks: { font: {size: 10} } } },
                interaction: { mode: 'nearest', axis: 'x', intersect: false }
            }
        });

        document.getElementById('lw-dark-check').onchange = (e) => {
            document.getElementById('lyon-widget').classList.toggle('lw-dark', e.target.checked);
            const textColor = e.target.checked ? '#ADB5BD' : '#666';
            state.chart.options.scales.x.ticks.color = textColor;
            state.chart.options.scales.y.ticks.color = textColor;
            state.chart.update();
        };

        switchCourse('saintelyon');
    }

    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
    else init();

})();
</script>
</body>
</html>
```

### Étape 3 : Tester et Héberger (Le point critique)

C'est ici que ça bloque souvent quand on est datajournaliste et pas développeur backend.

#### Problème : CORS (Cross-Origin Resource Sharing)
Si tu double-cliques simplement sur le fichier `index.html` sur ton ordinateur, ça ne marchera probablement pas. Le navigateur te dira : *"Accès refusé au fichier .gpx"*. C'est une sécurité.

#### Solution 1 : Tester en local
Si tu utilises **VS Code** (recommandé), installe l'extension "Live Server".
1.  Ouvre ton dossier `carte-saintelyon` dans VS Code.
2.  Fais un clic droit sur `index.html` -> "Open with Live Server".
3.  Ça marche !

#### Solution 2 : Mettre en production (sur leprogres.fr)
Pour que ça marche sur le site web :
1.  Connecte-toi à ton serveur via FTP (FileZilla) ou via le CMS du Progrès si tu as un accès média.
2.  Crée un dossier (ex: `/infographies/2025/saintelyon/`).
3.  Dépose **TOUT** le contenu : le fichier `index.html` ET le dossier `data/` avec les GPX dedans.
4.  Sur le site du Progrès, tu intègres ton app via une iFrame :
    ```html
    <iframe src="https://www.leprogres.fr/infographies/2025/saintelyon/index.html" width="100%" height="800" frameborder="0" style="border:0; overflow:hidden;"></iframe>